# ADR-006: Events Routing and Delivery Policy

## Status
Accepted

## Context

The Corpsite system implements business events (Events / Notifications) generated by the backend
when task state changes occur.

The Telegram bot uses polling via the `/tasks/me/events` endpoint to retrieve events
and deliver notifications to users.

After fixing:
- ACL invariants (ADR-004),
- events contract and poller behavior (ADR-005),

it became necessary to formally define the routing and delivery policy:
- who receives events,
- under which conditions,
- how Telegram binding is handled,
- which guarantees the system provides.

## Goals

- Prevent event leakage between users.
- Ensure deterministic notification delivery.
- Clearly separate backend and bot responsibilities.
- Provide a stable reference for tests and future development.

## Terminology

- Event: a business event related to a task (task_id, event_type, actor fields).
- Recipient: a user eligible to receive an event.
- Routing: determining the set of recipients.
- Delivery: sending a notification via Telegram.
- Bind: association between user_id and tg_id.

## Architectural Principles

1. Backend is the source of truth  
   - Backend determines which events a user can access via ACL.
   - Backend does not store or depend on Telegram data.

2. Bot is a delivery layer  
   - Bot retrieves events only through `/tasks/me/events`.
   - Bot does not extend or weaken backend ACL.
   - Bot is responsible for delivery and retries.

3. Pull-based model  
   - Backend does not push events.
   - Bot polls events per user.

## Routing Policy

### General Rule

An event is routed to every user who can access it through backend ACL,
provided that the user has an active Telegram bind.

The bot does not compute recipients itself.
It only queries the backend on behalf of a specific user_id.

### Roles and Visibility

| Role          | Receives events |
|---------------|-----------------|
| Initiator     | Yes, all task events |
| Executor      | Yes, assigned tasks |
| Supervisor    | Yes, within responsibility scope |
| Deputy        | Yes, per delegation rules |
| Administrator| Yes, if allowed by ACL |

### Self-events

Events triggered by the same user:
- are not filtered on the backend level;
- may be filtered by the bot for UX reasons only.

## Delivery Policy

### Delivery Conditions

An event is delivered if all conditions are met:
1. The user can access the event via `/tasks/me/events`.
2. The user has an active Telegram bind.
3. The bot is running and reachable.

### Missing Bind

If no bind exists:
- the event is not delivered;
- the event is not lost and remains available via API;
- no delivery retry is performed until bind exists.

Binding is the user's responsibility.

### Retry and Stability

- Poller uses `after_id` to guarantee idempotency.
- Duplicate deliveries are not allowed.
- If backend healthcheck fails, poller does not start (see ADR-005).

## Guarantees

### Guaranteed

- No cross-user event leakage.
- Deterministic ordering by event_id.
- Delivered events strictly follow backend ACL.

### Not Guaranteed

- Real-time delivery.
- Delivery without Telegram bind.
- Delivery when the bot is offline.

## Component Responsibilities

### Backend

- Event generation.
- ACL enforcement.
- `/tasks/me/events` contract.

### Bot

- Backend healthcheck.
- Event polling.
- Bind validation.
- Telegram delivery.
- Error logging.

## Testing

The policy is validated by:
- ACL non-leak tests.
- Events contract tests.
- Isolated seeding of users and tasks.

## Rejected Alternatives

1. Backend pushing events to the bot  
   Rejected due to tighter coupling and reduced fault tolerance.

2. Storing tg_id in backend  
   Rejected due to domain separation and security concerns.

3. Centralized routing logic in the bot  
   Rejected because it duplicates backend ACL logic.

## Related ADRs

- ADR-003: Error semantics (403 and 409)
- ADR-004: ACL invariants
- ADR-005: Events poller and contract

ADR-006 defines a clear and extensible routing and delivery model for Corpsite events.
