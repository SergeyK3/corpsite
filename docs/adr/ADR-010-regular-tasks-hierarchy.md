# ADR-010: Регулярные задачи, иерархия и приём отчётов

## Статус
Принято

## Контекст
В системе Corpsite реализуется иерархическая модель регулярных задач и отчётности
для управленческой вертикали:

- директор
- заместители
- руководители подразделений
- рядовые сотрудники

Задачи носят преимущественно регулярный характер (недельные и месячные),
создаются автоматически и замыкаются по уровням управления.

RBAC dept и справочники подразделений уже реализованы и используются как база.

---

## Ключевое решение

### 1. Регулярные задачи = шаблоны
Регулярные задачи не создаются вручную.
Они описываются в **справочнике шаблонов регулярных задач** и автоматически
инстанцируются по календарю.

Допускается корректировка справочника по мере необходимости
(через поддержку / администратора).

---

## Основные сущности

### TaskTemplate (шаблон регулярной задачи)
Создаётся один раз.

Содержит:
- название и описание (шаблон текста)
- периодичность: `weekly | monthly`
- уровень адресата:
  - `employee`
  - `head`
  - `deputy`
- привязку:
  - к `org_unit`
  - и/или роли
- KPI / метрику
- флаг активности

Шаблоны не имеют статуса выполнения.

---

### TaskInstance (экземпляр задачи периода)
Создаётся автоматически:
- при начале новой недели (неделя начинается в **четверг**),
- при начале нового календарного месяца.

Содержит:
- ссылку на `TaskTemplate`
- период (например: `2026-W05`, `2026-01`)
- исполнителя (user или org_unit)
- статус выполнения

---

### TaskReport (отчёт по задаче)
Отражает факт выполнения задачи.

Содержит:
- ссылку на `TaskInstance`
- данные отчёта (текст, значения KPI, вложения)
- дату сдачи
- автора отчёта

---

## Иерархическая логика отчётности

### Уровень 4 → 3  
**Сотрудник → Руководитель подразделения**
- сотрудник сдаёт отчёт по своей регулярной задаче;
- это автоматически:
  - закрывает его `TaskInstance`;
  - формирует данные для задачи руководителя по приёму отчётов.

---

### Уровень 3 → 2  
**Руководитель → Заместитель**
- руководитель сдаёт сводный отчёт;
- это соответствует задаче зама по приёму отчётов подразделений.

---

### Уровень 2 → 1  
**Заместитель → Директор**
- заместитель сдаёт отчёт;
- директор фактически принимает отчёты через отчёт заместителя.

---

## Приём отчётов (важное упрощение)

Приём отчётов **не является отдельным действием в UI**.

Приём реализуется как обычная задача,
статус которой вычисляется автоматически
по наличию отчётов на нижнем уровне.

### Статусы:
- `WAITING_REPORTS` — нет отчётов
- `PARTIALLY_DONE` — часть отчётов получена
- `DONE` — все отчёты получены

---

## Календарная логика

### Неделя
- неделя начинается в **четверг**
- используется собственная недельная логика (не стандарт ISO)

### Месяц
- календарный месяц

Эта логика считается **ядром системы** и не подлежит изменению без миграций.

---

## Роль RBAC

RBAC используется:
- для ограничения видимости задач и отчётов;
- для управления правами редактирования и подтверждений.

RBAC **не участвует в бизнес-логике формирования задач**.

Базовые принципы:
- исполнитель видит свои задачи;
- руководитель видит задачи своего подразделения;
- заместитель видит агрегированные данные по `scope_unit_ids`;
- директор видит все задачи и отчёты.

---

## Осознанно вне рамок (out of scope)
- UI/UX формулировки экранов
- визуальные дашборды KPI
- ручная постановка задач как основной сценарий

---

## Причины принятия решения

- снижает операционную нагрузку (нет ручной постановки задач);
- поддерживает масштабирование;
- обеспечивает сквозную управленческую отчётность;
- позволяет вводить UI поверх стабильной логики.

---

## Последствия

- требуется сервис автоматической генерации задач;
- требуется агрегирование отчётов по иерархии;
- UI строится поверх готовых инстансов задач и отчётов.
