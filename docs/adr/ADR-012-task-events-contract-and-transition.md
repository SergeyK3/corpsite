# ADR-012: Контракт событий задач и правило единого transition

## Статус
Принято

## Цель
Обеспечить, что:
- события для бота и UI формируются единообразно;
- доставка уведомлений не зависит от дублированной бизнес-логики в боте;
- все события возникают только из переходов состояния TaskInstance (state machine).

## Решение (обязательные правила)

### R1. Backend — единственный источник событий
События создаются только внутри backend при допустимых переходах статуса задачи и/или создании отчёта.
Запрещено эмитить события “в обход” state machine (из контроллеров напрямую, из бота, из внешних скриптов).

### R2. Bot — потребитель событий
Bot выполняет:
- polling `/tasks/me/events`,
- routing/delivery,
- UX-тексты и кнопки,
- формирование ссылок на UI.

Bot не вычисляет статусы и не принимает бизнес-решения.

### R3. Единая точка смены статуса (transition)
Любая смена `tasks.status_id` выполняется только через один helper (transition-функцию).
Эта функция:
- валидирует допустимость перехода,
- обновляет `tasks.status_id`,
- создаёт событие (task_events + recipients),
- пишет аудит (при необходимости).

## Стабильные ссылки
Ссылки в уведомлениях остаются стабильными:
- задача: `/tasks/{task_id}`
- отчёт: `/tasks/{task_id}/report` (или `/tasks/{task_id}/reports/{report_id}` при расширении)

## События (MVP-минимум)
События хранятся в `task_events` и доставляются через `task_event_recipients`.

### TASK_CREATED
Возникает при создании задачи (в т.ч. генерацией по периоду).

Минимальный payload:
- `period_id`, `regular_task_id` (если есть), `title`

### REPORT_SUBMITTED
Возникает при создании/обновлении `task_reports` и переходе задачи в статус ожидания приёма/аппрува.

Минимальный payload:
- `report_link`, `current_comment` (если есть)

### TASK_DONE
Возникает при переводе задачи в `DONE` (в т.ч. после approve или авто-завершения).

Минимальный payload:
- `reason` (например `approved`, `auto_all_child_reports_submitted`)

### TASK_OVERDUE (если реализуется)
Возникает при автоматическом переходе задачи в `OVERDUE`.

### TASK_CANCELLED (если реализуется)
Возникает при отмене задачи.

## Совместимость с текущими event_type
Если уже используются `REPORT_SUBMITTED`, `APPROVED`, `REJECTED`, допускается:
- либо оставить как “расширение” контракта,
- либо маппировать:
  - `APPROVED` → `TASK_DONE` (reason=`approved`)
  - `REJECTED` → (опц.) `TASK_REOPENED` / `STATUS_CHANGED`
Решение по переименованию принимается отдельно, без ломки бота.

## Последствия
- Любая логика, которая сейчас делает `UPDATE tasks SET status_id=...`, должна перейти на transition helper.
- Генерация задач по периодам должна создавать `TASK_CREATED` на каждую созданную задачу (или пачкой, но с корректными recipients).

# ADR-012: Контракт событий задач и правило единого transition

## Статус
Принято

## Контекст
- События доставляются ботом через `/tasks/me/events`.
- Backend хранит события в `task_events` и аудиторию в `task_event_recipients`.
- Cursor для polling = `audit_id` (монотонный), fallback = `event_id`.
- Сейчас часть смен статуса и эмиссии событий размазана по endpoints.

## Решение

### R1. Backend — единственный источник событий
События создаются только в backend при изменении статуса задачи и/или создании отчёта.
Запрещено:
- эмитить события из бота,
- эмитить события напрямую из handlers в обход transition.

### R2. Bot — потребитель событий
Bot выполняет:
- polling `/tasks/me/events`,
- delivery,
- UX-тексты и ссылки на UI.
Bot не вычисляет статусы и не содержит бизнес-логики переходов.

### R3. Единая точка смены статуса (transition)
Любая смена `tasks.status_id` выполняется только через `transition_task_status(...)`.
Transition обязан:
1) проверить допустимость перехода (по текущему `status_code`);
2) обновить `tasks.status_id`;
3) (опционально) записать audit;
4) создать событие через `app.events.create_task_event(...)`.

## Стабильные ссылки
- задача: `/tasks/{task_id}`
- отчёт: `/tasks/{task_id}/report` (или `/tasks/{task_id}/reports/{report_id}` при версионировании)

## События (минимум совместимый с текущей реализацией)
Хранилище: `task_events` (+ `task_event_recipients`).

- `TASK_CREATED` — задача создана (в т.ч. генерацией по периоду).
- `REPORT_SUBMITTED` — отчёт сдан и статус переведён в ожидание приёма.
- `APPROVED` — отчёт принят (может считаться частным случаем `TASK_DONE`).
- `REJECTED` — отчёт отклонён, задача возвращена на доработку.
- (опционально) `TASK_OVERDUE`, `TASK_CANCELLED`.

## Последствия
- Все места, где выполняется `UPDATE tasks SET status_id=...`, переводятся на `transition_task_status(...)`.
- Генерация задач по периоду обязана эмитить `TASK_CREATED` для созданных `task_id`.
