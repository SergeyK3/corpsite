ADR-004: ACL и контракты для Events / Notifications (v1)
Статус

Accepted

Контекст

В системе задач реализован механизм событий (Events / Notifications), доступных через API:

GET /tasks/me/events


События используются:

для отображения истории изменений задач;

для доставки уведомлений (в т.ч. через Telegram);

для построения пользовательских лент активности.

Первоначальная формулировка требований к ACL событий предполагала проверку изоляции между пользователями. Однако фактическая модель доступа в системе построена на основе ролей, а не конкретных пользователей.

Это требовало явной фиксации контрактов и корректного тестирования non-leak поведения.

Принятое решение
1. Модель доступа (ACL)

Доступ к событиям определяется role-based моделью, а не user-based.

Пользователь видит события, если выполняется хотя бы одно из условий:

Он является инициатором задачи (initiator_user_id);

Его role_id совпадает с executor_role_id задачи;

Его роль входит в привилегированные роли:

SUPERVISOR_ROLE_IDS

DEPUTY_ROLE_IDS

Следствие:

Все пользователи с одинаковым executor_role_id разделяют одну очередь задач и событий.

Это является осознанным архитектурным решением, а не утечкой данных.

2. Контракт /tasks/me/events (v1)
Ответ

HTTP 200 OK

JSON-массив объектов событий

Инварианты

Ответ всегда массив

Каждый элемент соответствует схеме Event v1

Сортировка:
event_id DESC (новые события первыми)

Количество элементов <= limit

Параметр after_id:

эксклюзивный

after_id >= 1

after_id=0 не поддерживается (422)

Временные метки

created_at допускает минимальный clock-skew (нестрогая проверка «не в будущем»)

3. Non-leak контракт
Что считается утечкой (ACL leak)

Пользователь получает события по задачам:

с другим executor_role_id

и без прав supervisor/deputy

и не являясь инициатором

Что не считается утечкой

Пользователи с одинаковым executor_role_id видят одни и те же события

Это корректно и соответствует очереди роли

4. Тестирование
Подход

Используется детерминированное сидирование

Создаются:

2 независимые роли (не supervisor/deputy)

2 пары (initiator + executor)

Для каждой пары создаётся задача и событие

Проверяется:

пользователь A видит только события своей роли

пользователь B видит только события своей роли

пересечения отсутствуют

Причина такого подхода

Тестирование non-leak между пользователями с одной ролью приводит к ложным срабатываниям и противоречит архитектуре системы.

Последствия
Плюсы

Контракт событий формализован и проверяем

Тесты отражают реальную модель безопасности

Исключены ложные non-leak дефекты

Блок Events готов к использованию в:

UI

Telegram-боте

фоновых обработчиках

Ограничения

Изоляция между пользователями с одной ролью не обеспечивается и не планируется

Для user-based isolation требуется отдельная архитектурная модель (не scope данного ADR)

Связанные материалы

tests/test_events_contract_v1.py

tests/_seed_acl.py

ADR-003: Unified error semantics (403 / 409)

API Contract: Events / Notifications (v1)