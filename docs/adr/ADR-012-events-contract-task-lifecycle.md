# ADR-012: Контракт событий жизненного цикла задач (Task Lifecycle Events Contract)

## Статус
Принято

## Решение
1) **Backend является единственным источником событий.**  
   События создаются только при допустимых переходах state machine `TaskInstance` и/или при создании `TaskReport`.

2) **Bot является потребителем событий.**  
   Bot не содержит бизнес-логики статусов/иерархии задач и не создаёт события.  
   Bot выполняет: polling → routing → delivery → UI-ссылки/тексты.

3) **События отражают переходы состояния, а не UI-действия.**  
   Любая “пользовательская активность” должна приводить к изменению состояния, а событие формируется от этого изменения.

4) **Стабильные ссылки сохраняются.**  
   - Задача: `/tasks/{task_id}`
   - Отчёт: `/tasks/{task_id}/report` (или `/tasks/{task_id}/reports/{report_id}` при версионировании)

---

## Термины
- **TaskTemplate** — шаблон регулярной задачи (справочник).
- **TaskInstance** — экземпляр задачи периода (stateful).
- **TaskReport** — отчёт по задаче.
- **State machine** — набор состояний и допустимых переходов `TaskInstance`.

---

## Требования к событиям

### Идемпотентность
- У каждого события есть `event_id`.
- Событие не должно создаваться повторно при ретраях (dedupe/unique ключ на стороне БД).

### Время
- `occurred_at` фиксируется backend при записи события.

### Минимальные поля события
- `event_id`, `event_type`, `occurred_at`
- `task_id` (если относится к задаче)
- `report_id` (если относится к отчёту)
- `actor_user_id` (кто инициировал действие/переход)
- `assignee_user_id`/`assignee_org_unit_id` (если применимо)
- `period_key` (если применимо)
- служебные: `auto`, `reason` (опционально)

---

## События (MVP)

### TASK_CREATED
**Триггер:** TaskInstance создана и переведена в `OPEN`  
**Переход:** `— → OPEN` или `DRAFT → OPEN`

Минимальный payload:
```json
{
  "event_type": "TASK_CREATED",
  "task_id": 123,
  "template_id": 10,
  "period_key": "2026-01",
  "title": "…",
  "due_at": "2026-01-31T18:00:00+05:00",
  "assignee_user_id": 456,
  "assignee_org_unit_id": 44,
  "actor_user_id": 258
}
